machine:
  php:
    version: 7.0.3
checkout:
  post:
    - git submodule sync
    - git submodule update --init
dependencies:
  pre:
    - echo "date.timezone = America/New_York" | tee -a "$(php -i | grep "Loaded Configuration File" | grep -oP "\/opt\/.*")"
    - mkdir bin
  override:
    - bash .run/builders/build-reqs/build-reqs.bash up-env
    - sudo composer self-update && composer update -n --prefer-dist
    - bash .run/builders/build-reqs/build-reqs.bash up-app
test:
  override:
    - mkdir -p $CIRCLE_TEST_REPORTS/phpunit
    - wget -O bin/phpunit https://phar.phpunit.de/phpunit.phar && chmod +x bin/phpunit
    - bin/phpunit -vvv --log-junit $CIRCLE_TEST_REPORTS/phpunit/junit.xml --configuration phpunit.xml.dist
  post:
    - wget -O bin/coveralls https://github.com/satooshi/php-coveralls/releases/download/v1.0.1/coveralls.phar && chmod +x bin/coveralls
    - bash .run/builders/build-reqs/build-reqs.bash dn-app
    - bash .run/builders/build-reqs/build-reqs.bash dn-env
    - mkdir $CIRCLE_ARTIFACTS/phpunit
    - mkdir $CIRCLE_ARTIFACTS/composer
    - mv var/build/clover.xml $CIRCLE_ARTIFACTS/phpunit/clover.xml
    - mv var/build/coverage $CIRCLE_ARTIFACTS/phpunit/coverage
    - mv composer.lock composer.json $CIRCLE_ARTIFACTS/composer/
notify:
  webhooks:
    - url: https://src.run/hooks/circle
